<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bobby-James PDF Reader</title>

    <script src="pdf.min.js"></script>
    <script src="mammoth.browser.min.js"></script>

    <style>
      :root {
        --primary: #00ff88;
        --bg: #121212;
        --panel: #1f1f1f;
        --text: #ffffff;
      }
      .dark-reader {
        --doc-bg: #1a1a1a !important;
        --doc-text: #e0e0e0 !important;
      }
      .light-reader {
        --doc-bg: #ffffff !important;
        --doc-text: #000000 !important;
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: "Segoe UI", sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      header {
        background: var(--panel);
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #333;
        z-index: 20;
        flex-wrap: wrap;
        gap: 15px;
      }

      /* History Sidebar */
      #history-sidebar {
        position: fixed;
        left: -220px;
        top: 60px;
        bottom: 0;
        width: 220px;
        background: var(--panel);
        border-right: 1px solid #333;
        transition: 0.3s;
        z-index: 15;
        padding: 15px;
      }
      #history-sidebar:hover {
        left: 0;
      }
      .history-label {
        font-size: 10px;
        color: var(--primary);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
        display: block;
      }
      .history-item {
        padding: 8px;
        font-size: 12px;
        border-bottom: 1px solid #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #ccc;
      }
      .sidebar-hint {
        position: absolute;
        right: -25px;
        top: 50%;
        transform: rotate(90deg);
        background: var(--primary);
        color: black;
        padding: 2px 10px;
        font-size: 10px;
        font-weight: bold;
        border-radius: 0 0 5px 5px;
      }

      .controls {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      #viewer-container {
        flex: 1;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        background: #000;
        position: relative;
      }

      #viewer {
        width: 90%;
        height: 95%;
        margin: auto;
        background: var(--doc-bg, white);
        color: var(--doc-text, black);
        overflow-y: auto;
        padding: 20px;
        border-radius: 4px;
        scroll-behavior: smooth;
        transition: transform 0.3s ease-out;
        transform-origin: center top;
      }

      .dark-reader #viewer canvas {
        filter: invert(0.9) hue-rotate(180deg);
      }
      .status-pill {
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 11px;
        background: #333;
        font-weight: bold;
      }
      .active {
        background: var(--primary);
        color: black;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 34px;
        height: 18px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #555;
        transition: 0.4s;
        border-radius: 20px;
      }
      input:checked + .slider {
        background-color: var(--primary);
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 12px;
        width: 12px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider:before {
        transform: translateX(16px);
      }

      #cooldown-overlay {
        position: fixed;
        top: 110px;
        right: 20px;
        width: 130px;
        display: none;
        text-align: center;
        background: rgba(0, 0, 0, 0.85);
        padding: 8px;
        border-radius: 8px;
        z-index: 100;
        border: 1px solid #444;
      }
      #cooldown-bar {
        height: 3px;
        background: var(--primary);
        width: 100%;
        margin-top: 5px;
      }

      #preview-canvas {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 100px;
        border: 1px solid var(--primary);
        border-radius: 6px;
        opacity: 0.4;
      }

      button {
        background: #333;
        color: white;
        border: 1px solid #555;
        padding: 6px 14px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: 0.2s;
      }
      button:hover {
        background: #444;
        border-color: var(--primary);
      }
      input[type="range"] {
        accent-color: var(--primary);
        width: 70px;
      }
    </style>
  </head>
  <body class="light-reader">
    <header>
      <div class="controls">
        <input type="file" id="fileInput" accept=".pdf,.docx,.txt" />
        <button id="themeToggle">ðŸŒ™ Mode</button>
        <button
          id="resetBtn"
          style="border-color: var(--primary); font-weight: bold"
        >
          ðŸ”„ Reset Zoom
        </button>
      </div>

      <div class="controls">
        <span style="font-weight: bold; color: var(--primary)"
          >Bobby-James Reader</span
        >
        <label class="switch">
          <input type="checkbox" id="motionToggle" checked />
          <span class="slider"></span>
        </label>
      </div>

      <div class="controls">
        <label>Sens: <span id="sensVal">18</span></label>
        <input type="range" id="sensSlider" min="5" max="50" value="18" />
      </div>

      <div id="ai-status" class="status-pill">AI LOADING...</div>
    </header>

    <div id="history-sidebar">
      <div class="sidebar-hint">HISTORY</div>
      <span class="history-label">Recent Documents</span>
      <div id="history-list">
        <div class="history-item">No history yet</div>
      </div>
    </div>

    <div id="cooldown-overlay">
      <small
        id="cooldown-text"
        style="color: var(--primary); font-size: 10px; font-weight: bold"
      ></small>
      <div id="cooldown-bar"></div>
    </div>

    <div id="viewer-container">
      <div id="viewer">
        <div style="text-align: center; margin-top: 50px; color: #888">
          <h1>ðŸ“– Bobby-James PDF Reader</h1>
          <p>Hover over the <b>left edge</b> to see recent files.</p>
          <p>Wait time is set to <b>4.4 seconds</b>.</p>
        </div>
      </div>
    </div>

    <video id="webcam" autoplay playsinline style="display: none"></video>
    <canvas id="preview-canvas"></canvas>

    <script type="module">
      import { FaceLandmarker, FilesetResolver } from "./vision_bundle.js";

      if (window.pdfjsLib)
        pdfjsLib.GlobalWorkerOptions.workerSrc = "./pdf.worker.min.js";

      const viewer = document.getElementById("viewer");
      const aiStatus = document.getElementById("ai-status");
      const motionToggle = document.getElementById("motionToggle");
      const resetBtn = document.getElementById("resetBtn");
      const sensSlider = document.getElementById("sensSlider");
      const themeToggle = document.getElementById("themeToggle");
      const cooldownOverlay = document.getElementById("cooldown-overlay");
      const historyList = document.getElementById("history-list");
      const video = document.getElementById("webcam");
      const previewCanvas = document.getElementById("preview-canvas");
      const pCtx = previewCanvas.getContext("2d");

      let faceLandmarker;
      let isCooldown = false;
      let sensitivity = 18;
      let currentZoom = 1.0;
      const COOLDOWN_MS = 4400;

      // --- HISTORY LOGIC ---
      function updateHistory(fileName) {
        let history = JSON.parse(
          localStorage.getItem("bj_reader_history") || "[]"
        );
        // Remove if exists (to move to top)
        history = history.filter((name) => name !== fileName);
        history.unshift(fileName);
        // Keep only top 8
        history = history.slice(0, 8);
        localStorage.setItem("bj_reader_history", JSON.stringify(history));
        displayHistory();
      }

      function displayHistory() {
        let history = JSON.parse(
          localStorage.getItem("bj_reader_history") || "[]"
        );
        if (history.length === 0) return;
        historyList.innerHTML = history
          .map((name) => `<div class="history-item">${name}</div>`)
          .join("");
      }

      // --- BUTTONS ---
      resetBtn.addEventListener("click", () => {
        currentZoom = 1.0;
        viewer.style.transform = `scale(1.0)`;
      });

      sensSlider.addEventListener("input", (e) => {
        sensitivity = parseInt(e.target.value);
        document.getElementById("sensVal").innerText = sensitivity;
      });

      themeToggle.addEventListener("click", () => {
        const isLight = document.body.classList.contains("light-reader");
        document.body.className = isLight ? "dark-reader" : "light-reader";
        themeToggle.innerText = isLight ? "â˜€ï¸ Light" : "ðŸŒ™ Mode";
      });

      // --- FILE LOADING ---
      document
        .getElementById("fileInput")
        .addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          updateHistory(file.name);
          viewer.innerHTML =
            "<div style='text-align:center;padding:50px;'>Processing...</div>";

          const reader = new FileReader();
          if (file.name.endsWith(".pdf")) {
            reader.onload = async function () {
              const pdf = await pdfjsLib.getDocument({
                data: new Uint8Array(this.result),
              }).promise;
              viewer.innerHTML = "";
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const canvas = document.createElement("canvas");
                viewer.appendChild(canvas);
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({
                  canvasContext: canvas.getContext("2d"),
                  viewport,
                }).promise;
              }
            };
            reader.readAsArrayBuffer(file);
          } else if (file.name.endsWith(".docx")) {
            reader.onload = (e) =>
              mammoth
                .convertToHtml({ arrayBuffer: e.target.result })
                .then(
                  (res) =>
                    (viewer.innerHTML = `<div style="padding:20px">${res.value}</div>`)
                );
            reader.readAsArrayBuffer(file);
          } else {
            reader.onload = (e) =>
              (viewer.innerHTML = `<pre style="padding:20px">${e.target.result}</pre>`);
            reader.readAsText(file);
          }
        });

      // --- AI LOGIC ---
      async function init() {
        displayHistory();
        try {
          const wasmPath =
            window.location.origin +
            window.location.pathname.replace(/\/[^\/]*$/, "/wasm");
          const filesetResolver = await FilesetResolver.forVisionTasks(
            wasmPath
          );
          faceLandmarker = await FaceLandmarker.createFromOptions(
            filesetResolver,
            {
              baseOptions: {
                modelAssetPath: `face_landmarker.task`,
                delegate: "GPU",
              },
              runningMode: "VIDEO",
              numFaces: 1,
            }
          );
          startCamera();
        } catch (e) {
          aiStatus.innerHTML = "âŒ ENGINE ERROR";
        }
      }

      function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
          video.srcObject = stream;
          video.onloadeddata = () => {
            aiStatus.innerHTML = "ACTIVE";
            aiStatus.classList.add("active");
            loop();
          };
        });
      }

      function loop() {
        const result = faceLandmarker.detectForVideo(video, performance.now());
        pCtx.save();
        pCtx.scale(-1, 1);
        pCtx.drawImage(
          video,
          -previewCanvas.width,
          0,
          previewCanvas.width,
          previewCanvas.height
        );
        pCtx.restore();

        if (
          motionToggle.checked &&
          result.faceLandmarks.length > 0 &&
          !isCooldown
        ) {
          const marks = result.faceLandmarks[0];
          const pitch = (marks[1].y - (marks[10].y + marks[152].y) / 2) * 1000;
          const roll = (marks[33].y - marks[263].y) * 1000;

          if (Math.abs(pitch) > sensitivity)
            triggerAction("scroll", pitch > 0 ? 400 : -400);
          else if (Math.abs(roll) > sensitivity)
            triggerAction("zoom", roll > 0 ? 0.25 : -0.25);
        }
        requestAnimationFrame(loop);
      }

      function triggerAction(type, val) {
        isCooldown = true;
        cooldownOverlay.style.display = "block";
        document.getElementById("cooldown-text").innerText =
          type.toUpperCase() + " (4.4s)";
        if (type === "scroll")
          viewer.scrollBy({ top: val, behavior: "smooth" });
        else {
          currentZoom = Math.min(Math.max(0.5, currentZoom + val), 3.0);
          viewer.style.transform = `scale(${currentZoom})`;
        }
        setTimeout(() => {
          isCooldown = false;
          cooldownOverlay.style.display = "none";
        }, COOLDOWN_MS);
      }

      init();
    </script>
  </body>
</html>
